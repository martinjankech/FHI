<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js"
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/footer.css">
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> -->
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"
    integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin="anonymous"></script>
  <!-- jqury kniznica na obmedzenie maximalneho poctu poloziek v autocomplete  -->
  <script src="js/jquery.ui.autocomplete.scroll.min.js"></script>
  <link href="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.css" rel="stylesheet" />
  <script src="js/app.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.css">
  <script type="text/javascript" charset="utf8"
    src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>
  <link rel="stylesheet" href="css/datatable.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/data.js"></script>
  <script src="https://code.highcharts.com/modules/drilldown.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css"
    integrity="sha384-vp86vTRFVJgpjF9jiIGPEEqYqlDwgyBgEF109VFjmqGmIY/Y4HV4d3Gp2irVfcrp" crossorigin="anonymous">
  <link rel="stylesheet" href="css/predaje.css">

  <title>Document</title>
</head>

<body>
  <div id="navbar">
  </div>
  <div style="display: none;" id="alert_error">
    <div class="alert alert-danger" role="alert">
      <span id="alert-text"></span>
    </div>
  </div>
  <div style="display: none;" id="alert_success">
    <div class="alert alert-success" role="alert">
      <span id="alert-text"></span>
    </div>
  </div>
  <div class="flex-wrapper">
    <div class="container">
      <h1 class="mb-3 mt-5">Hľadaj údaje o predajoch kníh podľa: </h1>
      <form class="col-12" id="formSellAtributesDates" method="POST">
        <div class="form-row ">
          <div class="form-group col-md-6">
            <label for="startDate">Datum od</label>
            <input type="date" class="form-control" id="startDate" placeholder="startdate">
          </div>
          <div class="form-group col-md-6">
            <label for="endDate">Datum do</label>
            <input type="date" class="form-control" id="endDate" placeholder="enddate">
          </div>
        </div>
        <div class="form-row ">
          <div class="form-group col-md-6">
            <label for="atributeValue">Hladať podla Atribútu</label>
            <select id="selectedAtribute" class="form-control">
              <option disabled selected value> zvoľte si možnosť prosím </option>
              <option value="autor">autor</option>
              <option value="kategoria">kategória</option>
              <option value="vydavatelstvo">vydavateľstvo</option>
              <option value="jazyk">jazyk</option>
              <option value="vazba">väzba</option>

            </select>
          </div>
        </div>
        <button type="submit" id="btnGetData" class="btn btn-primary ">potvrdiť</button>
      </form>
    </div>


    <div class="container mt-5 mb-3">
      <div class="row">
        <div class="col-md-6">
          <div class="card revenue-card">
            <div class="card-body">
              <h5 class="card-title">
                <i class="fas fa-money-bill-wave"></i> Total Revenue
              </h5>
              <p class="card-text" id="revenue"></p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card quantity-card">
            <div class="card-body">
              <h5 class="card-title">
                <i class="fas fa-box"></i> Total Quantity
              </h5>
              <p class="card-text" id="quantity"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid col-10 mt-4 mb-4" id="container"></div>

    <footer>

    </footer>
  </div>


</body>
<script>
  $("#navbar").load("navbar.html")
  $("footer").load("footer.html")
  $("#selectedAtribute").on('change', function () {
    $('#selectedValueAtribute').attr('placeholder', "zadajte hodnotu atributu " + $("select option:selected").val())
    switch ($("select option:selected").val()) {
      case "autor":
        createArrayFromNestedAttribute("autori", 'autor1').then(resolve => {
          data1 = resolve;
          createArrayFromNestedAttribute('autori', 'autor2').then(resolve => {
            data2 = resolve;
            let final = data2.concat(data1)

            console.log(final);

            autoCompleteInput('#selectedValueAtribute', 5, final)
          })
        })
        break;
      case "kategoria":
        createArrayFromOneAttribute1("kategoria").then(resolve => { autoCompleteInput('#selectedValueAtribute', 5, resolve) })
        break;
      case "vydavatelstvo":
        createArrayFromOneAttribute1("vydavatelstvo").then(resolve => { autoCompleteInput('#selectedValueAtribute', 5, resolve) })
        break;
      case "jazyk":
        createArrayFromOneAttribute1("jazyk").then(resolve => { autoCompleteInput('#selectedValueAtribute', 5, resolve) })
        break;
      case "vazba":
        createArrayFromOneAttribute1("vazba").then(resolve => { autoCompleteInput('#selectedValueAtribute', 5, resolve) })
        break;
      default:
        alert("atribut nebol zadany spravne ")
    }
  })

</script>
<script>

  $(document).on('submit', "#formSellAtributesDates", function (event) {

    var atribute = $("#selectedAtribute").val();
    var atributeText = $("#selectedAtribute option:selected").text();
    var startDate = $("#startDate").val();
    var endDate = $("#endDate").val();

    $.ajax({
      type: "POST",
      url: "http://localhost:8050/book_services.asmx/GetAggregatedDataSellByDateAndSelectedCategory",
      data: {
        atribute: atribute,
        startDate: startDate,
        endDate: endDate
      },

      dataType: "json",
      success: function (response) {
        try {
          var data = response;
          var podkategoriaData = [];
          data.AggregatedData.forEach(function (podkategoria) {
            podkategoriaData.push({
              name: podkategoria.Podkategoria,
              y: podkategoria.TotalRevenue,
              drilldown: podkategoria.Podkategoria
            });
          });
          console.log(podkategoriaData)


          var bookData = [];
          data.AggregatedData.forEach(function (podkategoria) {
            var books = [];
            podkategoria.Books.forEach(function (book) {
              books.push([book.Name, book.TotalRevenue]);
            });

            bookData.push({
              name: podkategoria.Podkategoria,
              id: podkategoria.Podkategoria,
              data: books
            });

          });

          let revenue = data.TotalAggregatedData.TotalRevenue;
          let quantity = data.TotalAggregatedData.TotalQuantity;
          document.getElementById("revenue").innerHTML = revenue;
          document.getElementById("quantity").innerHTML = quantity;

          // Create the chart
          Highcharts.chart('container', {
            chart: {
              type: 'column'
            },
            title: {
              text: "Príjmy podľa atribútu " + atributeText + " a jednotlivých kníh patriacich do atribútu"
            },
            xAxis: {
              type: 'category'
            },
            yAxis: {
              title: {
                text: 'Total Revenue'
              }
            },
            legend: {
              enabled: false
            },
            plotOptions: {
              series: {
                borderWidth: 0,
                dataLabels: {
                  enabled: true,
                  format: '${point.y:.2f}'
                }
              }
            },
            tooltip: {
              headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
              pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>${point.y:.2f}</b><br/>'
            },
            series: [{
              name: 'Podkategoria',
              colorByPoint: true,
              data: podkategoriaData
            }],
            drilldown: {
              series: bookData
            }
          });
        } catch (error) {
          console.error(error);
          alert("An error occurred: " + error.message);
        }
      },
      error: function (xhr, ajaxOptions, thrownError) {
        alert(xhr.status + " " + thrownError);
      }

    });
    event.preventDefault();
  });



</script>

</html>